{% extends "base.html" %}
{% block content %}
{% include "conescfs_styles.html" %}

<div class="cone-info-banner">
    <span class="cone-info-icon">ⓘ</span>
    <span class="cone-info-text">Units in N and mm only</span>
</div>

<form id="cone-input-form">

    <div class="cone-main-grid">

        <!-- TOP LEFT: Cone geometry inputs -->
        <div class="cone-geometry-section">
            <h4 class="cone-section-title">Cone geometry</h4>

            <div class="cone-form-row">
                <label for="cone_junction">Junction</label>
                <select id="cone_junction" name="cone_junction">
                    <option value="large" {% if cone_junction == 'large' %}selected{% endif %}>Large</option>
                    <option value="small" {% if cone_junction == 'small' %}selected{% endif %}>Small</option>
                </select>
            </div>

            <div class="cone-form-row">
                <label for="radius_tubular">Tubular radius</label>
                <input type="number" step="any" id="radius_tubular" name="radius_tubular" value="{{ radius_tubular }}">
            </div>

            <div class="cone-form-row">
                <label for="thickness_tubular">Tubular thk</label>
                <input type="number" step="any" id="thickness_tubular" name="thickness_tubular" value="{{ thickness_tubular }}">
            </div>

            <div class="cone-form-row">
                <label for="thickness_cone">Cone thk</label>
                <input type="number" step="any" id="thickness_cone" name="thickness_cone" value="{{ thickness_cone }}">
            </div>

            <div class="cone-form-row">
                <label for="alpha">Cone angle α (degrees)</label>
                <input type="number" step="any" id="alpha" name="alpha" value="{{ alpha }}">
            </div>

            <div class="cone-form-row">
                <label for="cone_x_axis_vary">X-axis vary</label>
                <select id="cone_x_axis_vary" name="cone_x_axis_vary">
                    <option value="radius_tubular" {% if cone_x_axis_vary == 'radius_tubular' %}selected{% endif %}>Tubular radius</option>
                    <option value="thickness_tubular" {% if cone_x_axis_vary == 'thickness_tubular' %}selected{% endif %}>Tubular thk</option>
                    <option value="thickness_cone" {% if cone_x_axis_vary == 'thickness_cone' %}selected{% endif %}>Cone thk</option>
                    <option value="alpha" {% if cone_x_axis_vary == 'alpha' %}selected{% endif %}>Cone angle α</option>
                </select>
            </div>

            <div class="cone-form-row">
                <label for="cone_x_axis_lims">X-axis limits</label>
                <select id="cone_x_axis_lims" name="cone_x_axis_lims">
                    <option value="t25" {% if cone_x_axis_lims == 't25' %}selected{% endif %}>+/-25%</option>
                    <option value="t50" {% if cone_x_axis_lims == 't50' %}selected{% endif %}>+/-50%</option>
                    <option value="t100" {% if cone_x_axis_lims == 't100' %}selected{% endif %}>+/-100%</option>
                </select>
            </div>


        </div>

        <!-- TOP RIGHT: Cone geometry image -->
        <div class="cone-image-box">
            <img id="cone-scf-img" src="{{ cone_scf_img }}" alt="Cone geometry sketch">
        </div>

        <!-- BOTTOM LEFT: Thickness transition inputs -->
        <div class="cone-transition-section">
            <h4 class="cone-subsection-title">Thickness transition</h4>
            <p class="cone-subsection-note">
                <em>Thickness transition SCFs calculated separately & can be combined with cone SCFs.</em>
            </p>

            <div class="cone-form-row">
                <label for="transition_side">Transition side</label>
                <select id="transition_side" name="transition_side">
                    <option value="inside" {% if transition_side == 'inside' %}selected{% endif %}>Inside</option>
                    <option value="outside" {% if transition_side == 'outside' %}selected{% endif %}>Outside</option>
                </select>
            </div>

            <div class="cone-form-row">
                <label for="scf_weld_type">Weld type</label>
                <select id="scf_weld_type" name="scf_weld_type">
                    <option value="single_sided" {% if scf_weld_type == 'single_sided' %}selected{% endif %}>Single sided</option>
                    <option value="double_sided" {% if scf_weld_type == 'double_sided' %}selected{% endif %}>Double sided</option>
                </select>
            </div>

            <div class="cone-form-row">
                <label for="weld_width">Weld width, L</label>
                <input type="number" step="any" id="weld_width" name="weld_width" value="{{ weld_width }}">
            </div>

            <div class="cone-form-row">
                <label for="scf_taper_ratio">
                    Taper ratio x<br>(1 in x)
                </label>
                <select id="scf_taper_ratio" name="scf_taper_ratio">
                    <option value="" {% if not scf_taper_ratio %}selected{% endif %}>None</option>
                    <option value="3" {% if scf_taper_ratio == 3 %}selected{% endif %}>3</option>
                    <option value="4" {% if scf_taper_ratio == 4 %}selected{% endif %}>4</option>
                    <option value="5" {% if scf_taper_ratio == 5 %}selected{% endif %}>5</option>
                    <option value="6" {% if scf_taper_ratio == 6 %}selected{% endif %}>6</option>
                </select>
            </div>

            <div class="cone-form-row">
                <label for="delta_m">&delta;<sub>m</sub></label>
                <input type="number" step="any" id="delta_m" name="delta_m" value="{{ delta_m }}">
            </div>

            <div class="cone-form-row">
                <label for="delta_0">&delta;<sub>0</sub> <br>(oft. 0.05t)</label>
                <input type="number" step="any" id="delta_0" name="delta_0" value="{{ delta_0 }}">
            </div>

            <div class="cone-form-row">
                <label for="scf_inclusion">Cone SCF inclusion</label>
                <select id="scf_inclusion" name="scf_inclusion">
                    <option value="yes_multiply" {% if scf_inclusion == 'yes_multiply' %}selected{% endif %}>Yes - multiply</option>
                    <option value="yes_linear_add" {% if scf_inclusion == 'yes_linear_add' %}selected{% endif %}>Yes - linear addition</option>
                    <option value="no" {% if scf_inclusion == 'no' %}selected{% endif %}>No</option>
                </select>
            </div>
        </div>

        <!-- BOTTOM RIGHT: Thickness transition image -->
        <div class="cone-image-box">
            <img id="tt-scf-img" src="{{ tt_scf_img }}" alt="Thickness transition sketch">
        </div>

    </div>

<!--    <button type="submit" class="cone-submit-button">Submit</button>-->

</form>


<!-- Implementation Approach -->
<div class="implementation-box">
    <h4>Implementation approach</h4>
    <div id="scf-msgs-table" class="cone-res-table">
        <!-- Messages inserted dynamically -->
    </div>
</div>


<div class="cone-results-container">
    <div class="cone-result-box">
        <h4 id="cone-heading">Cone only SCF results at large diameter junction</h4>

        <div id="cone-res-output" class="cone-res-table">

            <!-- Column headers -->
            <div class="cone-res-row">
                <div class="cone-res-group" colspan="2">Inside SCFs</div>
                <div class="cone-res-group" colspan="2">Outside SCFs</div>
            </div>

            <!-- Sub-headers -->
            <div class="cone-res-row">
                <div class="cone-res-subheader">Sect 3</div>
                <div class="cone-res-subheader">AppB3</div>
                <div class="cone-res-subheader">Sect 3</div>
                <div class="cone-res-subheader">AppB3</div>
            </div>

            <!-- Data rows -->
            <div class="cone-res-row">
                <div class="cone-res-cell">Tube: <span id="scf-tube-in">-</span></div>
                <div class="cone-res-cell">Tube: <span id="scf-tube-in-appf">-</span></div>
                <div class="cone-res-cell">Tube: <span id="scf-tube-out">-</span></div>
                <div class="cone-res-cell">Tube: <span id="scf-tube-out-appf">-</span></div>
            </div>
            <div class="cone-res-row">
                <div class="cone-res-cell">Cone: <span id="scf-cone-in">-</span></div>
                <div class="cone-res-cell">Cone: <span id="scf-cone-in-appf">-</span></div>
                <div class="cone-res-cell">Cone: <span id="scf-cone-out">-</span></div>
                <div class="cone-res-cell">Cone: <span id="scf-cone-out-appf">-</span></div>
            </div>

        </div>
    </div>

    <!--    thickness transition SCF results box-->
    <div class="cone-result-box two-col">
        <h4>Thickness transition only SCFs at large diameter junction</h4>
        <div class="cone-res-table">
            <!-- Header row - 2 columns-->
            <div class="cone-res-row">
                <div class="cone-res-group">Inside SCFs</div>
                <div class="cone-res-group">Outside SCFs</div>
            </div>
            <!-- Row 1 -->
            <div class="cone-res-row">
                <div class="cone-res-cell">
                    <span id="scf-inside-tt">-</span>
                </div>
                <div class="cone-res-cell">
                    <span id="scf-outside-tt">-</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!--Final results table includes (or not) the SCFs-->
<!-- Cone including thickness transition SCFs -->
<div class="cone-results-container">
    <div class="cone-result-box">
        <h4 id="cone-tt-heading">Cone including thickness transition SCFs</h4>
        <div class="cone-res-table">
            <!-- Column headers -->
            <div class="cone-res-row">
                <div class="cone-res-group" colspan="2">Inside SCFs</div>
                <div class="cone-res-group" colspan="2">Outside SCFs</div>
            </div>
            <!-- Sub-headers -->
            <div class="cone-res-row">
                <div class="cone-res-subheader">Sect 3</div>
                <div class="cone-res-subheader">AppB3</div>
                <div class="cone-res-subheader">Sect 3</div>
                <div class="cone-res-subheader">AppB3</div>
            </div>
            <!-- Data rows -->
            <div class="cone-res-row">
                <div class="cone-res-cell">Tube: <span id="scf-tube-in-tt">-</span></div>
                <div class="cone-res-cell">Tube: <span id="scf-tube-in-appf-tt">-</span></div>
                <div class="cone-res-cell">Tube: <span id="scf-tube-out-tt">-</span></div>
                <div class="cone-res-cell">Tube: <span id="scf-tube-out-appf-tt">-</span></div>
            </div>
            <div class="cone-res-row">
                <div class="cone-res-cell">Cone: <span id="scf-cone-in-tt">-</span></div>
                <div class="cone-res-cell">Cone: <span id="scf-cone-in-appf-tt">-</span></div>
                <div class="cone-res-cell">Cone: <span id="scf-cone-out-tt">-</span></div>
                <div class="cone-res-cell">Cone: <span id="scf-cone-out-appf-tt">-</span></div>
            </div>
        </div>
    </div>
</div>


<!-- Plot container -->
<div id="cone-scfs-plot-in" style="margin-top: 1rem; width: 60%; height: 500px;"></div>
<div id="cone-scfs-plot-out" style="margin-top: 1rem; width: 60%; height: 500px;"></div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const form = document.getElementById("cone-input-form");

    // Debounce helper
    function debounce(func, delay) {
        let timer;
        return function(...args) {
            clearTimeout(timer);
            timer = setTimeout(() => func.apply(this, args), delay);
        };
    }

    // Function to fetch results from server
    function fetchResults() {
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        fetch("/conescfs", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(updateResults)
        .catch(error => console.error("Error:", error));
    }

    // Function to update DOM based on server result
    function updateResults(result) {
        if(result.status !== "success") return;

        // Images
        document.getElementById("cone-scf-img").src = result.cone_scf_img;
        document.getElementById("tt-scf-img").src = result.tt_scf_img;

        // Cone SCFs
        document.getElementById("scf-tube-in").textContent = result.scf_tube_in.toFixed(3);
        document.getElementById("scf-cone-in").textContent = result.scf_cone_in.toFixed(3);
        document.getElementById("scf-tube-out").textContent = result.scf_tube_out.toFixed(3);
        document.getElementById("scf-cone-out").textContent = result.scf_cone_out.toFixed(3);

        document.getElementById("scf-tube-in-appf").textContent = result.scf_tube_in_appf.toFixed(3);
        document.getElementById("scf-cone-in-appf").textContent = result.scf_cone_in_appf.toFixed(3);
        document.getElementById("scf-tube-out-appf").textContent = result.scf_tube_out_appf.toFixed(3);
        document.getElementById("scf-cone-out-appf").textContent = result.scf_cone_out_appf.toFixed(3);

        // Thickness transition SCFs
        document.getElementById("scf-inside-tt").textContent = result.scf_inside_tt.toFixed(3);
        document.getElementById("scf-outside-tt").textContent = result.scf_outside_tt.toFixed(3);

        // Cone + TT SCFs
        document.getElementById("scf-tube-in-tt").textContent = result.scf_tube_in_tt.toFixed(3);
        document.getElementById("scf-cone-in-tt").textContent = result.scf_cone_in_tt.toFixed(3);
        document.getElementById("scf-tube-out-tt").textContent = result.scf_tube_out_tt.toFixed(3);
        document.getElementById("scf-cone-out-tt").textContent = result.scf_cone_out_tt.toFixed(3);

        document.getElementById("scf-tube-in-appf-tt").textContent = result.scf_tube_in_appf_tt.toFixed(3);
        document.getElementById("scf-cone-in-appf-tt").textContent = result.scf_cone_in_appf_tt.toFixed(3);
        document.getElementById("scf-tube-out-appf-tt").textContent = result.scf_tube_out_appf_tt.toFixed(3);
        document.getElementById("scf-cone-out-appf-tt").textContent = result.scf_cone_out_appf_tt.toFixed(3);

        // SCF messages
        const msgsTable = document.getElementById("scf-msgs-table");
        msgsTable.innerHTML = "";
        Object.values(result.scf_msgs).forEach(msg => {
            const row = document.createElement("div");
            row.className = "cone-res-row";

            const cell = document.createElement("div");
            cell.className = "cone-res-cell";
            cell.textContent = msg;

            row.appendChild(cell);
            msgsTable.appendChild(row);
        });

        // Plotly
        Plotly.react('cone-scfs-plot-in', JSON.parse(result.conescfs_plot_json_in).data, JSON.parse(result.conescfs_plot_json_in).layout);
        Plotly.react('cone-scfs-plot-out', JSON.parse(result.conescfs_plot_json_out).data, JSON.parse(result.conescfs_plot_json_out).layout);

        // Update headings
        const cone_heading = document.getElementById("cone-heading");
        if(result.scf_inclusion === "yes_multiply" || result.scf_inclusion === "yes_linear_add") {
            cone_heading.textContent = "Cone SCF results. Cone and tube thickness replaced with min(tube thickness, cone thickness).";
        } else {
            cone_heading.textContent = `Cone SCF results at ${result.cone_junction} diameter junction.`;
        }

        const cone_tt_heading = document.getElementById("cone-tt-heading");
        if(result.scf_inclusion === "yes_multiply") {
            cone_tt_heading.textContent = "Cone including thickness transition SCFs (multiplication)";
        } else if(result.scf_inclusion === "yes_linear_add") {
            cone_tt_heading.textContent = "Cone including thickness transition SCFs (linear addition)";
        } else {
            cone_tt_heading.textContent = "Cone ONLY SCFs (not incl. thickness transition SCFs)";
        }
    }

    // Debounced version of fetchResults for input changes
    const debouncedFetch = debounce(fetchResults, 300);

    // Attach to all inputs & selects
    form.querySelectorAll("input, select").forEach(input => {
        input.addEventListener("input", debouncedFetch);
        input.addEventListener("change", debouncedFetch);
    });

    // --- INITIAL FETCH on page load ---
    fetchResults();
});
</script>




{% endblock %}
