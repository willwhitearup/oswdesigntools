{% extends "base.html" %}

{% block content %}

{% block styles %}
  {% include 'mto_styles.html' %}
{% endblock %}

<form method="GET" action="">
  <label for="num_legs">No. of legs:</label>
  <select name="num_legs" id="num_legs" onchange="this.form.submit()" style="width: 60px;">
    <option value="3" {% if num_legs == '3' %}selected{% endif %}>3</option>
    <option value="4" {% if num_legs == '4' %}selected{% endif %}>4</option>
  </select>
</form>
<br>

<p><strong>Total jacket mass: {{ total_mass_sum }} t</strong></p>

<table class="table table-striped mto-table">
  <thead>
    <tr>
      {% for col in columns %}
        <th>{{ col }}</th>
      {% endfor %}
    </tr>
  </thead>
  <tbody>
    {% for row in data %}
      <tr>
        {% for col in columns %}
          <td>{{ row[col] }}</td>
        {% endfor %}
      </tr>
    {% endfor %}
  </tbody>
</table>

<div>
  <button id="mto-export-csv" class="mto-button">Export (csv)</button>
</div>
<br><br>


<script>
document.addEventListener('DOMContentLoaded', function () {
  const table = document.querySelector('.mto-table');
  const headers = table.querySelectorAll('th');
  let sortDirection = {};

  headers.forEach((header, colIndex) => {
    sortDirection[colIndex] = 1;
    header.style.cursor = 'pointer';

    // Create and attach a sort icon
    const sortIcon = document.createElement('span');
    sortIcon.className = 'sort-icon';
    sortIcon.textContent = '↕'; // Default indicator
    header.appendChild(sortIcon);

    header.addEventListener('click', () => {
      const tbody = table.querySelector('tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const isNumeric = !isNaN(rows[0]?.children[colIndex]?.innerText.trim());

      rows.sort((a, b) => {
        const valA = a.children[colIndex].innerText.trim();
        const valB = b.children[colIndex].innerText.trim();

        return sortDirection[colIndex] * (
          isNumeric
            ? parseFloat(valA) - parseFloat(valB)
            : valA.localeCompare(valB)
        );
      });

      // Reset all headers
      headers.forEach((h, i) => {
        h.classList.remove('sorted-asc', 'sorted-desc');
        h.querySelector('.sort-icon').textContent = '↕';
      });

      // Apply new sort direction
      header.classList.add(sortDirection[colIndex] === 1 ? 'sorted-asc' : 'sorted-desc');
      sortIcon.textContent = sortDirection[colIndex] === 1 ? '▲' : '▼';

      // Flip direction
      sortDirection[colIndex] *= -1;

      // Re-append sorted rows
      rows.forEach(row => tbody.appendChild(row));
    });
  });
});

document.getElementById('mto-export-csv').addEventListener('click', function () {
  const table = document.querySelector('.mto-table');
  const rows = Array.from(table.querySelectorAll('tr'));
  const csv = rows.map(row => {
    return Array.from(row.querySelectorAll('th, td'))
      .map(cell => `"${cell.innerText.replace(/"/g, '""')}"`) // Escape double quotes
      .join(',');
  }).join('\n');

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.setAttribute('href', url);
  link.setAttribute('download', 'jacket_mto.csv');
  link.style.display = 'none';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
});
</script>




{% endblock %}